{% extends "base.html" %}
{% block content %}
<section class="dashboard-header">
  <div>
    <h1 class="dashboard-title">Savings Goals</h1>
    <p class="dashboard-subtitle">
      Track where you’re heading and how close you are.
    </p>
  </div>
</section>

<section style="display: grid; grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr); gap: 1.1rem">
  <!-- Goals list -->
  <div class="card">
    <div class="card-inner">
      <div class="card-header">
        <span class="card-title">Active Goals</span>
        <span class="card-tag">
          {{ goals|length }} total
        </span>
      </div>

      <div class="goals-list" id="goals-list">
        {% if goals %}
          {% for g in goals %}
            {% set pct = (g.Saving / g.amount * 100) if g.amount else 0 %}
            <div class="goal-item">
              <div class="goal-top">
                <span class="goal-name">{{ g.title }}</span>
                <span class="goal-progress">
                  ₹ {{ '%.0f'|format(g.Saving) }} / {{ '%.0f'|format(g.amount) }}
                </span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: {{ pct|round(0) }}%"></div>
              </div>
              <p class="dashboard-subtitle" style="margin-top: 0.25rem">
                Created on {{ g.dateAdded.strftime('%d %b %Y') }}
              </p>
            </div>
          {% endfor %}
        {% else %}
          <p class="dashboard-subtitle" id="no-goal-text">No goals yet. Add your first goal on the right.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Create goal form -->
  <div class="card">
    <div class="card-inner">
      <div class="card-header">
        <span class="card-title">Create Goal</span>
        <span class="card-tag">AJAX · No reload</span>
      </div>

      <div id="goal-form">
        <div class="form-grid">
          <div class="form-field">
            <label for="goal-name">Goal name</label>
            <input
              type="text"
              id="title"
              name="title"
              placeholder="e.g. Emergency fund"
              required
            />
          </div>

          <div class="form-field">
            <label for="target-amount">Target amount (₹)</label>
            <input
              type="number"
              id="amount"
              name="amount"
              min="0"
              step="0.01"
              placeholder="0.00"
              required
            />
          </div>

          <div class="form-field">
            <label for="current-amount">Current saved (₹)</label>
            <input
              type="number"
              id="saving"
              name="saving"
              min="0"
              step="0.01"
              placeholder="0.00"
            />
          </div>

          <div class="form-field">
            <label for="deadline">Target date</label>
            <input type="date" id="date" name="date" />
          </div>

        
        </div>

        <div style="margin-top: 0.7rem; display: flex; gap: 0.5rem; justify-content: flex-end">
          <button type="reset" class="btn btn-secondary">Reset</button>
          <button type="button" class="btn" id="addGoal">Save Goal</button>
        </div>
      </div>
    </div>
  </div>
</section>
<script>
  const ResetData = () => {
  document.getElementById("title").value = ""
  document.getElementById("amount").value = ""
  document.getElementById("saving").value = ""
  document.getElementById("date").value = ""
}

const loadData =async () =>{
document.getElementById("goals-list").innerHTML=""
try {
  const res = await fetch("/goals", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
  });
  const data = await res.json();
  document.getElementsByClassName("card-tag")[0].innerHTML = `${data.length} total`
  data.forEach(goal => {
  
      document.getElementById("goals-list").innerHTML += `  
            <div class="goal-item">
              <div class="goal-top">
                <span class="goal-name">${goal.title}</span>
                <span class="goal-progress">
                  ₹ ${goal.saved.toFixed(0)} / ${goal.target.toFixed(0)}
                </span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${goal.progress}%"></div>
              </div>
              <p class="dashboard-subtitle" style="margin-top: 0.25rem">
                Created on ${goal.date}
              </p>
            </div>
              
    `
    
  })
}
      
catch (err) {
  console.error(err);
  alert("Network error while fetching expenses");
}}

  document.addEventListener("DOMContentLoaded", ()=>{

    document.getElementById("date").value = new Date().toISOString().split("T")[0]
    document.getElementById("addGoal").addEventListener("click", async () => {
      title = document.getElementById("title").value
      
      amount = document.getElementById("amount").value
      saving = document.getElementById("saving").value
      date = document.getElementById("date").value
      // console.log(title, category, amount, isExpense, date)
        url = "/add_goals?title="+title+"&amount="+amount+"&saving="+saving+"&dateAdded="+date


      try{
const res = await fetch(url, {
        method: "GET",
        headers: { "Content-Type": "application/json" },

      });

      if (res.ok) {
        await loadData();
        return;
      }}
      catch(err){
        console.error(err);
        alert("Network error while saving expense");
      }


    })
  })
</script>
{% endblock %}

{% block scripts %}
<script>

</script>
{% endblock %}
